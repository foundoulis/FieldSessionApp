<!DOCTYPE html>

<html>

<head>
  <meta charset="utf-8">
  <title>Transform Launcher</title>
  <link rel="stylesheet" href="mainscreen.css">
</head>

<body onload="window.resizeTo(900, 550)">
  <div class="logo">
    <div>
      <img src="di_logo_login.png" alt="https://login.drillinginfo.com/auth/resources/7.0.0.ga/login/di-theme/img/di_logo_login.png" width="75%" height="19%" id="logo">
    </div>
  </div>

  <div>
    <h3 id="version"> Version <!-- default value --> </h3>
  </div>

  <div class="user">
    <h2 id="username">
      Username: <!-- default value -->
    </h2>
    <div>
      <!-- TODO add tooltip text to icons -->
      <img src="../icons/transform.png" width="15%" height="15%" id="basic">
      <!-- <span class="tooltiptext">transfrom</span> -->
      <img src="../icons/beta_1.png" width="15%" height="15%" id="beta">
      <!-- <span class="tooltiptext">beta user</span> -->
      <img src="../icons/support_1.png" width="15%" height="15%" id="mms">
      <!-- <span class="tooltiptext">support user</span> -->
    </div>
  </div>

  <div class="news">
    <!-- start sw-rss-feed code -->
    <script type="text/javascript">
    rssfeed_url = new Array();
    rssfeed_url[0]="https://news.google.com/news?cf=all&hl=en&pz=1&ned=us&topic=tc&output=rss";
    rssfeed_frame_width="100%";
    rssfeed_frame_height="600";
    rssfeed_scroll="on";
    rssfeed_scroll_step="6";
    rssfeed_scroll_bar="off";
    rssfeed_target="_blank";
    rssfeed_font_size="15";
    rssfeed_font_face="";
    rssfeed_border="off";
    // rssfeed_css_url="http://feed.surfing-waves.com/css/style1.css";
    rssfeed_title="on";
    rssfeed_title_name="";
    rssfeed_title_bgcolor="#76be43";
    rssfeed_title_color="#fff";
    rssfeed_title_bgimage="http://";
    rssfeed_footer="off";
    rssfeed_footer_name="rss feed";
    rssfeed_footer_bgcolor="#d3d3d3";
    rssfeed_footer_color="#333";
    rssfeed_footer_bgimage="http://";
    rssfeed_item_title_length="50";
    rssfeed_item_title_color="#1c1b1d";
    rssfeed_item_bgcolor="#d3d3d3";
    rssfeed_item_bgimage="http://";
    rssfeed_item_border_bottom="on";
    rssfeed_item_source_icon="off";
    rssfeed_item_date="off";
    rssfeed_item_description="on";
    rssfeed_item_description_length="120";
    rssfeed_item_description_color="#666";
    rssfeed_item_description_link_color="#333";
    rssfeed_item_description_tag="off";
    rssfeed_no_items="0";
    rssfeed_cache = "de820a463df884c6f106de56b1573ecf";
    </script>
    <script type="text/javascript" src="http://feed.surfing-waves.com/js/rss-feed.js"></script>
    <!-- The link below helps keep this service FREE, and helps other people find the SW widget. Please be cool and keep it! Thanks. -->
    <div style="text-align:right; width:180px;"><a href="http://www.surfing-waves.com/feed.htm" target="_blank" style="color:#ccc;font-size:10px">widget @</a> <a href="http://www.surfing-waves.com" target="_blank" style="color:#ccc;font-size:10px">surfing-waves.com</a></div>
    <!-- end sw-rss-feed code -->
  </div>

  <div class="tools">
    <h2 id="header"> Tools </h2>
  </div>

  <div class="update">
    <button id='update'> Update </button>
  </div>

  <div class="progress-bar">
    <div class="progress"></div>
  </div>

  <div class="launch">
    <button id="launch">Launch</button>
  </div>

</body>

<script type="text/javascript">
var jarParser = require('./jarParser');

var login = require('./login.js');

var accessToken = jarParser.getToken.access_token; // token from jarParser
//var username = login.getUsername(); //username from login

jarParser.buildAndRunCommand("x4m-mines1", "mines1");
var accessToken;
setTimeout(function() {
  accessToken = jarParser.getToken().access_token; // token from jarParser
  console.log("accessToken: " + accessToken);
  // TODO: do something when update is pressed
  var update = document.getElementById('update');
  update.onclick = function() {
    console.log('Update Button');
  }

  // TODO: do something when launch is pressed
  var launch = document.getElementById('launch');
  launch.onclick = function() {
    console.log('Launch Button');
  }

  // Updates version number TODO: use the access token to do so
  function updateVersionNumber(number){
    var version = document.getElementById('version');
    version.innerHTML = "Version " + number;
  }

  // Updates username TODO: use username from login to do so
  function updateUsername(name){
    var version = document.getElementById('username');
    version.innerHTML = "Username: " + name;
  }

  // changes entitlement icons
  function showImage(id, visible) {
    var img = document.getElementById(id);
    img.style.opacity = 0.4;
  }

  // executes the curl instruction
  function execCommand(command, callback) {
    exec(command, (error, stdout, stderr) => {
      if (error !== null) {
        console.log('exec error: ' + error);
      }
      callback(stdout);
    });
  }

  // var test = require("../test.json");
  var exec = require('child_process').exec;

  var curlCommand = "curl -X POST https://di-api.dev.drillinginfo.com/v1/x4m/authorizations -H 'authorization: Bearer " + accessToken + "' -H 'cache-control: no-cache' -H 'content-type: application/json' -H 'x-api-key: 1d77ee834f92ece6b2ddd38b5ccc6b13' -d '{\"requests\":[{\"uri\":\"http://app.drillinginfo.com/x4m/x4m60\",\"action\":\"GET\"},{\"uri\":\"http://app.drillinginfo.com/4xm/x4mms\",\"action\":\"GET\"},{\"uri\":\"http://app.drillinginfo.com/x4m/x4mbeta\",\"action\":\"GET\"}]}'"
  var auth;

  execCommand(curlCommand, parser);

  var perm1;
  var perm2;
  var perm3;


  // parses entitlement JSON
  function parser(commandOutput) {
    auth = JSON.parse(commandOutput);
    console.log(auth);
    var perm1 = auth.authorizations[0].result;
    var perm2 = auth.authorizations[1].result;
    var perm3 = auth.authorizations[2].result;
    // printJSON(commandOutput);
    // TODO: change these to the actual permissions once TOKEN is global
    if (perm1 == "deny") {
      showImage("basic", false);
    }
    if (perm2 == "deny") {
      showImage("mms", false);
    }
    if (perm3 == "deny") {
      showImage("beta", false);
    }
  }

document.cookie = "username=a test; path=/";

  function readCookie(name) {
  	var nameEQ = name + "=";
  	var ca = document.cookie.split(';');
  	for(var i=0;i < ca.length;i++) {
  		var c = ca[i];
  		while (c.charAt(0)==' ') c = c.substring(1,c.length);
  		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
  	}
  	return null;
  }


  console.log(perm1);
  console.log(perm2);
  console.log(perm3);

  updateVersionNumber('6.0');
  updateUsername(readCookie(username));
}, 2000);

  require('./renderer.js');

  // var curlCommand = "curl -X POST https://di-api.dev.drillinginfo.com/v1/x4m/authorizations -H 'authorization: Bearer <<ACCESS TOKEN>>' -H 'cache-control: no-cache' -H 'content-type: application/json' -H 'x-api-key: 1d77ee834f92ece6b2ddd38b5ccc6b13' -d '{"requests":[{"uri":"http://app.drillinginfo.com/x4m/x4m60","action":"GET"},{"uri":"http://app.drillinginfo.com/4xm/x4mms","action":"GET"},{"uri":"http://app.drillinginfo.com/x4m/x4mbeta","action":"GET"}]}'"

  // execCommand(curlCommand, parser);

</script>

</html>
