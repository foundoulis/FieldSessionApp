<!DOCTYPE html>
<!-- html for the main screen of the launcher -->
<html>

<head>
  <meta charset="utf-8">
  <title>Transform Launcher</title>
  <link rel="stylesheet" href="mainscreen.css">
</head>
<!-- resize window to optimal size -->

<body onload="window.resizeTo(900, 550)">
  <div class="logo">
    <div>
      <img src="../icons/di_logo_login.png" alt="https://login.drillinginfo.com/auth/resources/7.0.0.ga/login/di-theme/img/di_logo_login.png" width="75%" height="19%" id="logo">
    </div>
  </div>
  <!-- Version container -->
  <div>
    <h3 id="version"> Version <!-- default value --> </h3>
  </div>
  <!-- Username container -->
  <div class="user">
    <h2 id="username">
      Username: <!-- default value -->
    </h2>
    <div>
      <!-- images for entitlement -->
      <img src="../icons/transform.png" alt="alternative text" title="Transform" width="15%" height="15%" id="basic">
      <img src="../icons/beta_1.png" alt="alternative text" title="Beta" width="15%" height="15%" id="beta">
      <img src="../icons/support_1.png" alt="alternative text" title="Support" width="15%" height="15%" id="mms">
    </div>
  </div>
  <!-- news container -->
  <div class="news">
    <!-- start sw-rss-feed code -->
    <script type="text/javascript">
      rssfeed_url = new Array();
      rssfeed_url[0] = "https://www.nasa.gov/rss/dyn/lg_image_of_the_day.rss";
      rssfeed_frame_width = "100%";
      rssfeed_frame_height = "600";
      rssfeed_scroll = "on";
      rssfeed_scroll_step = "6";
      rssfeed_scroll_bar = "off";
      rssfeed_target = "_blank";
      rssfeed_font_size = "15";
      rssfeed_font_face = "";
      rssfeed_border = "off";
      rssfeed_title = "on";
      rssfeed_title_name = "";
      rssfeed_title_bgcolor = "#76be43";
      rssfeed_title_color = "#fff";
      rssfeed_title_bgimage = "http://";
      rssfeed_footer = "off";
      rssfeed_footer_name = "rss feed";
      rssfeed_footer_bgcolor = "#d3d3d3";
      rssfeed_footer_color = "#333";
      rssfeed_footer_bgimage = "http://";
      rssfeed_item_title_length = "50";
      rssfeed_item_title_color = "#1c1b1d";
      rssfeed_item_bgcolor = "#d3d3d3";
      rssfeed_item_bgimage = "http://";
      rssfeed_item_border_bottom = "on";
      rssfeed_item_source_icon = "off";
      rssfeed_item_date = "off";
      rssfeed_item_description = "on";
      rssfeed_item_description_length = "120";
      rssfeed_item_description_color = "#666";
      rssfeed_item_description_link_color = "#333";
      rssfeed_item_description_tag = "off";
      rssfeed_no_items = "0";
      rssfeed_cache = "de820a463df884c6f106de56b1573ecf";
    </script>
    <script type="text/javascript" src="http://feed.surfing-waves.com/js/rss-feed.js"></script>
    <!-- The link below helps keep this service FREE, and helps other people find the SW widget. Please be cool and keep it! Thanks. -->
    <div style="text-align:right; width:180px;"><a href="http://www.surfing-waves.com/feed.htm" target="_blank" style="color:#ccc;font-size:10px">widget @</a> <a href="http://www.surfing-waves.com" target="_blank" style="color:#ccc;font-size:10px">surfing-waves.com</a></div>
    <!-- end sw-rss-feed code -->
  </div>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script>
    var exec = require("child_process").exec;

    function execCommand(command, callback) {
      exec(command, (error, stdout, stderr) => {
        if (error !== null) {
          console.log('exec error: ' + error);
        }
        callback(stdout);
      });
    }
    $(function() {
      var links = [];

      $.getJSON('./tools.json', function(data) {
        $.each(data.tools, function(i, f) {
          // var newLink = "<a" + " onclick='execCommand('echo hello', function(stdout){console.log(stdout)})', href='#'>" + f.name + "</a>" + "<br>"

          var newLink = "<a" + " id='toolButtons' onclick='execCommand('" + f.launch.command + " " + f.launch.value + "', function(stdout) {console.log(stdout);})', href='#', onclick = execCommand(" + f.launch.command + " " + f.launch.value + ")>" + f.name + "</a>" + "<br>"

          console.log(newLink);

          if (f.entitlements === 'x4m60') {
            $(newLink).appendTo("#toolContainer");
          }

        });
      });
    })
  </script>
  <!-- Tools container -->

  <div class="tools" id="toolContainer">
    <h2 id="header"> Tools </h2>
    <a id='toolButtons' onclick='execCommand('xdg-open transform/release/guide.txt', function(stdout)', href='#'>Create DB</a><br>
  </div>
  <!-- Update button -->
  <div class="update">
    <button id='update'> Update </button>
  </div>
  <!-- loading bar -->
  <div class="progress-bar">
    <div class="progress" id="progBar"></div>
  </div>
  <!-- Launch button -->
  <div class="launch">
    <button id="launch">Launch</button>
  </div>

</body>

<script src="https://sdk.amazonaws.com/js/aws-sdk-2.61.0.min.js"></script>
<!-- main script -->
<script type="text/javascript">
  let numberTotalFiles = 1;

  var jarParser = require('./jarParser');

  var accessToken = jarParser.getToken.access_token; // token from jarParser

  var async = require("async");

  var accessToken;

  function setAccessToken() {
    accessToken = jarParser.getToken().access_token; // token from jarParser
    console.log("AccessToken: " + accessToken);
  }

  var versionsList = [];
  var releaseNumber;
  // TODO: do something when update is pressed
  var update = document.getElementById('update');
  update.onclick = function() {
    if (versionsList.length > 0) {
      versionList.forEach(function(ver) {
        getVersionFiles(ver.obj, ver.releasesIndex);
      });
    }
    console.log('Update Button');
    updateApplication();
  }

  // TODO: do something when launch is pressed
  var launch = document.getElementById('launch');

  var exec = require('child_process').exec;
  var auth;
  var launchCommand;
  // executes unix instruction
  function execCommand(command, callback) {
    exec(command, {
      shell: '/bin/bash'
    }, (error, stdout, stderr) => {
      if (error !== null) {
        console.log('exec error: ' + error);
      }
      callback(stdout);
    });
  }
  launch.onclick = function() {
    // Insert the launch string here.
    execCommand("java -jar ./jars/helloWorld.jar", (stdout) => {
    //   console.log(stdout)
    });
    // console.log(JSON.stringify(versionsTransform));
    console.log("./" + versionsTransform.releases[1].launch.command + " " + versionsTransform.releases[1].launch.config + " " + versionsTransform.releases[1].launch.value); //, (stdout) => {console.log(stdout)}
    execCommand(launchCommand,
    (error, stdout, stderr) => {
        console.log(stdout);
        if(error !== null) {
            console.log(error);
        }
    });
  }

  var fs = require("fs");

  // Updates version number TODO: use the access token to do so
  function updateVersionNumber(number) {
    var version = document.getElementById('version');
    version.innerHTML = "Version " + number;
  }

  // checks for if the transform file alread exists and extracts version number
  fs.readdir("./transform/release/", (err, files) => {
    updateVersionNumber(files[1].slice(files[1].indexOf('_') + 1, files[1].lastIndexOf('.')));
  });

  // Updates username TODO: use username from login to do so
  function updateUsername(name) {
    var version = document.getElementById('username');
    version.innerHTML = "Username: " + name;
  }

  // changes entitlement icons
  function showImage(id) {
    var img = document.getElementById(id);
    img.style.opacity = 0.4;
  }

  //variables to store permissions
  var userEntitlements = [];

  // parses entitlement JSON
  function parser(commandOutput) {
    auth = JSON.parse(commandOutput);
    var perm1 = auth.authorizations[0].result;
    var perm2 = auth.authorizations[1].result;
    var perm3 = auth.authorizations[2].result;

    //logic for entitlement tiles
    if (perm1 == "deny") {
      showImage("basic");
    } else {
      var perm1Name = auth.authorizations[0].resource.split("/");
      userEntitlements.push(perm1Name[perm1Name.length - 1]);
    }
    if (perm2 == "deny") {
      showImage("mms");
    } else {
      var perm2Name = auth.authorizations[0].resource.split("/");
      userEntitlements.push(perm2Name[perm2Name.length - 1]);
    }
    if (perm3 == "deny") {
      showImage("beta");
    } else {
      var perm3Name = auth.authorizations[0].resource.split("/");
      userEntitlements.push(perm3Name[perm3Name.length - 1]);
    }
  }

  // grabs token from server and updates entitlements
  // function tokenHandler() {
  //   async.series([
  //     function (callback) {
  //       jarParser.buildAndRunCommand(require('electron').remote.getGlobal('username').name, require('electron').remote.getGlobal('password').pass);
  //     },
  //     function () {
  //       setAccessToken();
  //       var curlCommand = "curl -X POST https://di-api.dev.drillinginfo.com/v1/x4m/authorizations -H 'authorization: Bearer " + accessToken +
  //       "' -H 'cache-control: no-cache' -H 'content-type: application/json' -H 'x-api-key: 1d77ee834f92ece6b2ddd38b5ccc6b13' -d '{\"requests\":[{\"uri\":\"http://app.drillinginfo.com/x4m/x4m60\",\"action\":\"GET\"},{\"uri\":\"http://app.drillinginfo.com/4xm/x4mms\",\"action\":\"GET\"},{\"uri\":\"http://app.drillinginfo.com/x4m/x4mbeta\",\"action\":\"GET\"}]}'"
  //       execCommand(curlCommand, parser);
  //       console.log(accessToken);
  //     }
  //   ], function(err, results){
  //     if(err) (console.log(err));
  //     console.log(results);
  //   });
  // }

  // grabs token from server and updates entitlements
  function tokenHandler() {
    jarParser.buildAndRunCommand(require('electron').remote.getGlobal('username').name, require('electron').remote.getGlobal('password').pass);
    // delay a bit for jarParser to finish
    setTimeout(function() {
      setAccessToken();
      //fetch json from server
      var curlCommand = "curl -X POST https://di-api.dev.drillinginfo.com/v1/x4m/authorizations -H 'authorization: Bearer " + accessToken +
        "' -H 'cache-control: no-cache' -H 'content-type: application/json' -H 'x-api-key: 1d77ee834f92ece6b2ddd38b5ccc6b13' -d '{\"requests\":[{\"uri\":\"http://app.drillinginfo.com/x4m/x4m60\",\"action\":\"GET\"},{\"uri\":\"http://app.drillinginfo.com/4xm/x4mms\",\"action\":\"GET\"},{\"uri\":\"http://app.drillinginfo.com/x4m/x4mbeta\",\"action\":\"GET\"}]}'"
      execCommand(curlCommand, parser);
    }, 3000);
  }

  /*
   ******************************************************************** S3 server stuff********************************************************************
   */

  // import entire SDK
  // var AWS = require('aws-sdk');
  // // import AWS object without services
  // var AWS = require('aws-sdk/global');

  // import individual service
  // var S3 = require('aws-sdk/clients/s3');
  //
  // var s3 = new AWS.S3({
  //   accessKeyId: "yours3key",
  //   secretAccessKey: "yours3secret",
  //   maxRetries: 3,
  //   // any other options are passed to new AWS.S3()
  //   // See: http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#putObject-property
  // });
  //
  // // var client = s3.createClient({
  // //   maxAsyncS3: 20, // this is the defaultSo we have to use callbackCounter to keep track of how many tasks have finished. If an error occurs we also have to handle this in a special way for each task. And we have code duplication.
  // //   s3RetryCount: 3, // this is the default
  // //   s3RetryDelay: 1000, // this is the default
  // //   multipartUploadThreshold: 20971520, // this is the default (20 MB)
  // //   multipartUploadSize: 15728640, // this is the default (15 MB)
  // //   s3Options: {
  // //
  // //   },
  // // });
  //
  // var params = {
  //   Bucket: 'di-transform',
  //   Key: 'config.json',
  //   // other options supported by getObject
  //   // See: http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#getObject-property
  //   };
  //
  // s3.getObject(params, function(err, data) {
  //   if (err) console.log(err, err.stack); // an error occurred
  //   else console.log(data); // successful response
  //   /*
  //   data = {
  //    AcceptRanges: "bytes",
  //    ContentLength: 3191,
  //    ContentType: "image/jpeg",
  //    ETag: "\"6805f2cfc46c0f04559748bb039d69ae\"",
  //    LastModified: <Date Representation>,
  //    Metadata: {
  //    },
  //    TagCount: 2,
  //    VersionId: "null"
  //   }
  //   */
  // });

  var request = require("request");

  var config = "https://s3.amazonaws.com/di-transform/config.json";
  // for the java platform
  var platformURL;
  var versionsJavaURL;
  var configJSON;
  var platformJSON;
  var versionsJava;
  var updatesJava = false;
  var automaticJava = false;
  // for the transform jars
  var applicationsURL;
  var applicationsJSON;
  var versionsTransformURL;
  var versionsTransform;
  var updatesTransform = false;
  var automaticTransform = false;

  // takes url, sets it to JSON, then returns body in callback for debugging
  function getRequest(requestURL, setJSON, callback) {
    request.get(requestURL, function(error, response, body) {
      if (!error && response.statusCode == 200) {
        setJSON(body);
        callback(null, requestURL)
      } else if (error) {
        callback(error, null);
      } else {
        callback(new Error("HTML statuscode: " + response.statuscode), null);
      }
    });
  }

  function getVersionFiles(versionObj, releasesIndex) {
    var fs = require("fs");
    if (versionsJava === {}) return;
    // console.log(releasesIndex);
    var server = versionObj.releases[releasesIndex].server;

    var list = []
    // assuming that all patch releases will be at a smaller index than full file
    if (versionObj.releases.length > 1 && releasesIndex !== versionObj.releases.length-1) {
      // release is a patch and only the jar needs updating
      // should only put transform_X.Y.Z in list file
      var patchFileIndex = versionObj.releases[releasesIndex].files.indexOf("transform_" + versionObj.releases[releasesIndex].version + ".jar")
      list.push(versionObj.releases[releasesIndex].files[patchFileIndex]);
      list.push("");
      console.log("Installing patch...");
    } else {
      list = versionObj.releases[releasesIndex].files;
    }
    numberTotalFiles = list.length;
    // TODO: reintialize loading bar here

    Array.prototype.forEach.call(list, function(file) {
      if (file === "") return;
      url = server + "/" + file;
      // check if file exists before downloading it
      fs.stat(versionObj.releases[releasesIndex].local + "/" + file, (err) => {
        if (err !== null) {
          request.get(url, function(error, response, body) {
            if (!error && response.statusCode == 200) {
              var pathArray = file.split("/");
              var path = "/";
              for (i = 0; i < pathArray.length - 1; i++) {
                path += pathArray[i] + "/";
              }
              pathname = versionObj.releases[releasesIndex].local + path;
              var mkdirp = require("mkdirp");
              mkdirp(pathname, (err) => {
                if (err) {
                  console.log(err);
                }
                // removes old tranform_X.Y.Z.jar when trying to install an updated version
                if (file.includes("transform_") && file.includes(".jar")){
                  fs.unlink("./" + versionObj.releases[releasesIndex].local + "/" + "transform_" + versionObj.releases[versionObj.releases.length-1].version + ".jar", (err) => {
                    if (err !== null && err !== "ENOENT") console.log(err);
                  });
                }
                fs.writeFile(versionObj.releases[releasesIndex].local + "/" + file, body, (err) => {
                  if (err !== null) console.log(err)
                });

              })
            } else if (error) {
              console.log(error);
            } else {
              console.log(new Error("HTML statuscode: " + response.statuscode));
            }
          }); // end request
        }
      }); // end file.stat
      // update progress bar
      moveBar();
    }); // end file loop
  }

  // automatically called to check for updatesJava
  function updatePlatform() {
    async.series([
      function(callback) {
        getRequest(config, setConfigJSON, callback);
      },
      function(callback) {
        setPlatformAndApplicationURL(callback);
      },
      function(callback) {
        getRequest(applicationsURL, setApplicationsJSON, callback);
      },
      function(callback) {
        getRequest(platformURL, setPlatformJSON, callback);
      },
      function(callback) {
        getRequest(versionsJavaURL, setVersionsJava, callback);
      }
    ], function(err, results) {
      //optional callback function goes here
      if (err) console.log(err);
      else console.log(results);
    });
  }

  function setConfigJSON(obj) {
    configJSON = JSON.parse(obj);
  }

  function setPlatformAndApplicationURL(callback) {
    var os = process.platform;
    console.log(os);
    switch (os) {
      case "linux":
        platformURL = configJSON.launcher.installation[0].platforms;
        applicationsURL = configJSON.launcher.installation[0].applications;
        break;
      case "darwin":
        platformURL = configJSON.launcher.installation[1].platforms;
        applicationsURL = configJSON.launcher.installation[1].applications;
        break;
      case "win32":
      case "win64":
        platformURL = configJSON.launcher.installation[2].platforms;
        applicationsURL = configJSON.launcher.installation[2].applications;
        break;
      default:
        console.log("platform not supported")
        break;
    }
    callback(null, {
      platformURL,
      applicationsURL
    });
  }

  function setApplicationsJSON(obj, callback) {
    applicationsJSON = JSON.parse(obj);
    updatesTransform = applicationsJSON.applications[0].updates;
    automaticTransform = applicationsJSON.applications[0].automatic;
    versionsTransformURL = applicationsJSON.applications[0].versioning;
  }

  function setPlatformJSON(obj) {
    platformJSON = JSON.parse(obj);
    versionsJavaURL = platformJSON.platform[0].versioning;
    updatesJava = platformJSON.platform[0].updates;
    automaticJava = platformJSON.platform[0].automatic;
    // TODO: do something in here to handle platform flags for automatic updating or prompting
    // console.log(platformJSON);
  }

  function setVersionsJava(obj) {
    versionsJava = JSON.parse(obj);
    if (automaticJava) {
      // automatically update java
      getVersionFiles(versionsJava, 0);
    } else {
      // add version file to list to be updated on Update button click
      versionsList.push({
        "obj": versionsJava,
        "releasesIndex": 1
      });
    }
  }

  //************** transform jar stuff ******************
  function updateApplication() {
    async.series([
      function(callback) {
        getRequest(versionsTransformURL, setVersionsTransform, callback);
      },
      function(callback){
        checkForPatch();
      }
    ], function(err, results) {
      //optional callback function goes here
      if (err) console.log(err);
      else console.log(results);
    });
  }

  function setVersionsTransform(obj) {
    versionsTransform = JSON.parse(obj);
    releaseNumber = 1;

    // TODO: think about putting the chunk below in its own function??
    updateVersionNumber(versionsTransform.releases[releaseNumber].version);
    // update Transform jar (already clicked update or it was automatic)
    if (userAccess(versionsTransform.releases[releaseNumber].entitlements.split(','))) {
      // if user has proper entitlements download files and set up launch button
      getVersionFiles(versionsTransform, releaseNumber);
      // handle the rest of the version file here
      setLaunchCommand(releaseNumber);
    }
  }

  function checkForPatch(){
    // TODO: ask what the protocol is for adding patches and if they will always be above the base version
    if (userAccess("x4mms")){ // patch access
      releaseNumber = 0;
      console.log("User has access to x4mms patches");
      getVersionFiles(versionsTransform, releaseNumber);

      // handle the rest of the version file here
      updateVersionNumber(versionsTransform.releases[releaseNumber].version);
      setLaunchCommand(releaseNumber);
    }
  }

  function setLaunchCommand(releaseIndex){
    launchCommand = "./" + versionsTransform.releases[releaseIndex].launch.command + " " + versionsTransform.releases[releaseIndex].launch.config + " " + versionsTransform.releases[releaseIndex].launch.value;
  }

  function userAccess(entitlements) {
    list []
    if (entitlements.length != 1){
      console.log(entitlements.length);
      Array.prototype.forEach.call(entitlements, function(element) {
        if (!userEntitlements.includes(element)) {
          return false;
        }
      });
      return true;
    } else {
      if (userEntitlements.includes(entitlements)){
        return true;
      }
    }
    return false;
  }

  /*
   * S3 server stuff end
   */

  // var downloader = client.downloadFile(params);
  // downloader.on('error', function(err) {
  //   console.error("unable to download:", err.stack);
  // });
  // downloader.on('progress', function() {
  //   console.log("progress", downloader.progressAmount, downloader.progressTotal);
  // });
  // downloader.on('end', function() {
  //   console.log("done downloading");
  // });

  // document.cookie = "username=a test; path=./";
  //
  // const ses = window.session;
  // console.log("madeit")
  //
  // const cookie = {name: "snickerdoodle", value: "workPlease"};
  // ses.defaultSession.cookies.set(cookie, (error) => {
  //   if (error) console.error(error);
  // })
  //
  // ses.defaultSession.cookies.get({}, (error, cookies) => {
  //   console.log(error, cookies);
  // })
  //
  //   function readCookie(name) {
  //   	var nameEQ = name + "=";
  //   	var ca = document.cookie.split(';');
  //   	for(var i=0;i < ca.length;i++) {
  //   		var c = ca[i];
  //   		while (c.charAt(0)==' ') c = c.substring(1,c.length);
  //   		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
  //   	}
  //   	return null;
  //   }

  // console.log(perm1);
  // console.log(perm2);
  // console.log(perm3);

  // updateUsername(readCookie(username));

  // run automatically
  async.series([
    tokenHandler(),
    updateUsername(require('electron').remote.getGlobal('username').name),
    updatePlatform(),
    function() {
      // automatically update transform
      if (automaticTransform) {
        updateApplication();
      }
    }
  ], function(err, results) {
    //optional callback function goes here
    if (err) console.log(err);
    else console.log(results);
  });

  // for electron process handling
  require('./renderer.js');

  function moveBar() {
    var elem = document.getElementById("progBar");
    var width = 1;
    var prog = 0;
    var id = setInterval(frame, 10);

    function frame() {
      //
      if (width >= numberTotalFiles) {
        clearInterval(id);
      } else {

        width++;
        prog = width / numberTotalFiles;

        if (prog * 100 >= ((width - 1) / numberTotalFiles) * 100) {
          elem.style.width = prog * 100 + '%';
          //  console.log(numberTotalFiles);
          //  console.log(width);
          //  console.log(prog * 100 );
        }
      }
    }
  }
</script>

</html>
